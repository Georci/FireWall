<a name="pCgNv"></a>
# ç®€ä»‹
æœ¬ä»£ç ç”¨äºæ£€æµ‹é‡å…¥æ”»å‡»ï¼Œç»™å®šä¸€ç¬”äº¤æ˜“çš„tx_hashï¼Œå¯æ£€æµ‹è¯¥äº¤æ˜“æ˜¯å¦å­˜åœ¨é‡å…¥é£é™©ã€‚

æ£€æµ‹æ€æƒ³åŸºäºæ•°æ®åº“å¹¶å‘è¯»å†™å­˜åœ¨çš„é—®é¢˜ã€‚æ™ºèƒ½åˆçº¦çš„é‡å…¥æ”»å‡»æœ¬è´¨ä¸æ•°æ®åº“çš„å¹¶å‘è¯»å†™ç±»ä¼¼ã€‚é‡å…¥æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œå³ä¸€ä¸ªå‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡æ–°è¿›å…¥è¯¥å‡½æ•°ã€‚ä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡è¿›å…¥è¯¥å‡½æ•°æ—¶ï¼Œç”±äºç¬¬ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€ä¿®æ”¹çš„çŠ¶æ€å¹¶æœªçœŸæ­£å†™å…¥çŠ¶æ€æ•°æ®åº“ï¼Œå› æ­¤åœ¨æœ¬æ¬¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ•°æ®å¹¶ä¸ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼Œä¹Ÿå³æ•°æ®çš„è„è¯»å†™é—®é¢˜ã€‚

ç”±ä¸Šå¯çŸ¥ï¼Œé‡å…¥æ”»å‡»çš„æœ¬è´¨å³ä¸ºå¯¹æ•°æ®çš„è„è¯»å†™ã€‚åŸºäºè¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§æ£€æµ‹é‡å…¥æ”»å‡»çš„æ–°æ–¹æ³•ï¼Œå³å°†æ ¹æ®æ•°æ®åº“å¹¶å‘è¯»å†™å­˜åœ¨çš„é—®é¢˜å¯¹é‡å…¥æ”»å‡»è¿›è¡Œæ£€æµ‹ã€‚

:::info
æ•°æ®åº“å¹¶å‘è¯»å†™å­˜åœ¨çš„é—®é¢˜å¦‚ä¸‹å›¾
:::
![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1721012658675-1d3a4315-024a-484f-afda-15e34a007c33.png#averageHue=%23f8f8f7&clientId=u59378234-a788-4&from=paste&height=512&id=u9dfcce35&originHeight=768&originWidth=1855&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=556098&status=done&style=none&taskId=ucdde4108-8481-47dc-bed9-8003994b162&title=&width=1236.6666666666667)

:::info
æœ¬ä»£ç å¯¹äºé‡å…¥æ”»å‡»çš„æ£€æµ‹åŸºäºå­—èŠ‚ç çš„æ‰§è¡Œæ¨¡å¼ï¼Œå³ç”±æ•°æ®åº“å¹¶å‘è¯»å†™å­˜åœ¨çš„é—®é¢˜æ¨å¯¼å‡º5ç§é‡å…¥é£é™©æ¨¡å¼ã€‚è¿™äº›é‡å…¥é£é™©æ¨¡å¼çš„ä½œç”¨æ˜¯ï¼šé’ˆå¯¹åˆçº¦çš„æŸä¸ªçŠ¶æ€å˜é‡ï¼Œåªè¦å…¶åœ¨äº¤æ˜“æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¬¦åˆé‡å…¥é£é™©æ¨¡å¼ï¼Œåˆ™è®¤ä¸ºè¯¥çŠ¶æ€å˜é‡å¯èƒ½è¢«é‡å…¥æ”»å‡»ã€‚
:::

è¯¥ä»£ç ä¸‹ä¸€æ­¥éœ€è¦å®Œå–„è¯»åå·®çŠ¶æ€æœºçš„ç¼–å†™ã€‚
<a name="M544y"></a>
# æ•´ä½“æ¶æ„
![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1721012923142-a4fc5c84-3bdb-42d9-b4ab-278048a012b9.png#averageHue=%23f8f7f6&clientId=u59378234-a788-4&from=paste&height=632&id=u15407749&originHeight=948&originWidth=1813&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=367938&status=done&style=none&taskId=uf41a30ba-8994-44d8-b731-b546183868f&title=&width=1208.6666666666667)

<a name="fTjAO"></a>
## å‡†å¤‡å·¥ä½œ
é’ˆå¯¹å·²æœ‰äº¤æ˜“ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä»¥å¤ªåŠå½’æ¡£èŠ‚ç‚¹ä¸­è¯»å–å…¶call_traceï¼Œè€Œåæ ¹æ®call_traceåˆ†æå…¶æ‰€æœ‰callè°ƒç”¨è·¯å¾„ã€‚é‡å…¥æ¼æ´çš„ä¸»è¦ç‰¹å¾å°±æ˜¯é€’å½’ï¼Œå› æ­¤å…¶callè°ƒç”¨è·¯å¾„å¿…ç„¶å­˜åœ¨ç¯è·¯ã€‚æˆ‘ä»¬ä¸‹ä¸€æ­¥å°±æ˜¯ç­›é€‰å‡ºå­˜åœ¨ç¯è·¯çš„callè°ƒç”¨è·¯å¾„ã€‚é’ˆå¯¹è¯¥callè°ƒç”¨è·¯å¾„ä¸­çš„é‡å¤å‡ºç°çš„åœ°å€ï¼Œæˆ‘ä»¬å°†å…¶æ‰€æœ‰çš„storageè¿›è¡Œç›‘æ§ã€‚
<a name="KIFVE"></a>
## æ£€æµ‹è¿‡ç¨‹
åœ¨å‡†å¤‡å·¥ä½œå®Œæˆåï¼Œæˆ‘ä»¬å°†äº¤æ˜“è¿›è¡Œé‡æ”¾ï¼Œå¹¶åœ¨æ¯æ¬¡æ‰§è¡Œå®Œä¸€æ¡æŒ‡ä»¤åï¼Œæ£€æµ‹storageéšç€æ‰§è¡Œè¿‡ç¨‹çš„å˜åŒ–æ˜¯å¦å¦‚æ‰§è¡Œ**é‡å…¥é£é™©æ¨¡å¼**ä¸€æ ·ã€‚ä¸€æ—¦æ£€æµ‹åˆ°æŸä¸ªstorageå­˜åœ¨é£é™©ï¼Œåˆ™æˆ‘ä»¬è®¤ä¸ºè¯¥äº¤æ˜“å­˜åœ¨é‡å…¥é£é™©ã€‚

<a name="dMRU9"></a>
# ç›®å½•ç»“æ„
**commonæ¨¡å—ï¼šåŒ…å«åŸºæœ¬ç±»å‹çš„å°è£…**<br />**	- config.pyï¼šé…ç½®æ–‡ä»¶ï¼Œé…ç½®rpcä½¿ç”¨**<br />**	- constant.pyï¼šä»£ç æ‰€ä½¿ç”¨çš„å¸¸é‡**<br />**	- evm_network.pyï¼šä»¥å¤ªåŠç½‘ç»œçš„å±æ€§å°è£…**<br />**	- evm_opcode.pyï¼šæŒ‡ä»¤çš„å…·ä½“å®ç°**<br />**	- global_object.pyï¼šEVMçš„åŸºæœ¬ç»“æ„å®ç°**<br />**- detectoræ¨¡å—ï¼šé‡å…¥æ¼æ´æ£€æµ‹åŠŸèƒ½**<br />**	- entrypoint.pyï¼šåˆå§‹åŒ–é‡å…¥æ¼æ´æ£€æµ‹å™¨**<br />**	- path.pyï¼šè·¯å¾„ç±»å°è£…ï¼Œæ ¹æ®call_traceè·å¾—æ‰€æœ‰è°ƒç”¨è·¯å¾„å’Œæ‰€æœ‰ç¯è·¯è°ƒç”¨ã€‚**<br />**	- reentrancy_detector.pyï¼šé‡å…¥æ£€æµ‹å™¨ï¼Œç”¨äºè·å¾—äº¤æ˜“ä¿¡æ¯ï¼Œæ£€æµ‹äº¤æ˜“æ˜¯å¦å­˜åœ¨é‡å…¥æ”»å‡»ã€‚**<br />**	- state_machin.pyï¼šé‡å…¥æ£€æµ‹çŠ¶æ€æœºï¼ŒåŒ…å«å·²å®šä¹‰çš„é‡å…¥æ‰§è¡Œæ¨¡å¼ã€‚**<br />**	- taint_engine.pyï¼šæ±¡ç‚¹åˆ†æå¼•æ“**<br />**	- test.pyï¼šæµ‹è¯•ä»£ç **<br />**- EXPæ¨¡å—ï¼šå…¨ç½‘æ£€æµ‹æ—¶ä½¿ç”¨çš„ä»£ç **<br />**	- get_all_call_trace.pyï¼šè·å–æ‰€æœ‰äº¤æ˜“çš„call_trace**<br />**	- find_loop.pyï¼šåˆ†æäº¤æ˜“æ˜¯å¦ç¯è·¯**<br />**	- detect_all_tx.pyï¼šåˆ†æäº¤æ˜“æ˜¯å¦ä¸ºé‡å…¥æ”»å‡»**<br />**	- foreach_result.pyï¼šåˆ†æç»“æœ**<br />**	- exp_utils.pyï¼šå·¥å…·ç±»**

<a name="vcXDd"></a>
# ä¸»è¦å¯¹è±¡
<a name="WGeF5"></a>
## çŠ¶æ€æœº
é‡å…¥é£é™©æ¨¡å¼æ˜¯å­—èŠ‚ç çš„æ‰§è¡Œæ¨¡å¼ï¼ŒçŠ¶æ€æœºæ˜¯æ¯ä¸ªå­—èŠ‚ç æ‰§è¡Œåå¯¹æ‰§è¡Œæ¨¡å¼çš„æ£€æµ‹ã€‚
```python
class State:
    # çŠ¶æ€å·
    number: int
    # æ˜¯å¦ä¸ºåˆæ€
    is_start: bool
    # æ˜¯å¦ä¸ºç»ˆæ€
    is_final: bool

    def __init__(self,
                 number: int,
                 is_start: bool = False,
                 is_final: bool = False):
        self.number = number
        self.is_start = is_start
        self.is_final = is_final
```

```python
class StateMachine:
    # å½“å‰çŠ¶æ€
    state: State
    # çŠ¶æ€é›†åˆ(çŠ¶æ€å·=>çŠ¶æ€)
    all_states: dict[int, State]
    # åˆæ€åºå·
    start_state_number = 9999
    # ç»ˆæ€åºå·
    final_state_number = 10000

    def __init__(self):
        # å¼€å§‹éƒ½æ˜¯åˆæ€
        self.state = State(self.start_state_number, True)
        self.all_states = {self.start_state_number: self.state}

    # å½“å‰çŠ¶æ€å·
    @property
    def number(self) -> int:
        return self.state.number

    # å½“å‰æ˜¯å¦ä¸ºåˆæ€
    @property
    def is_start(self) -> bool:
        return self.state.is_start

    # å½“å‰æ˜¯å¦ä¸ºç»ˆæ€
    @property
    def is_final(self) -> bool:
        return self.state.is_final

    # è®¾ç½®çŠ¶æ€é›†åˆ
    def set_states(self, state_num: int, state: State):
        self.all_states[state_num] = state

    # çŠ¶æ€åˆ‡æ¢
    def state_transfer(self, state_num: int):
        self.state = self.all_states[state_num]
```
çŠ¶æ€æœºæœ€ä¸»è¦çš„å†…å®¹åœ¨ä¸‹é¢çš„ä»£ç ï¼Œæ¯å½“æ‰§è¡Œå®Œä¸€ä¸ªå­—èŠ‚ç ï¼ŒçŠ¶æ€æœºä¼šæ£€æµ‹å½“å‰çŠ¶æ€æ˜¯å¦ç¬¦åˆé‡å…¥é£é™©æ¨¡å¼çš„æŸä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœç¬¦åˆåˆ™çŠ¶æ€å‘åæ”¹å˜ã€‚**å…³é”®å‡½æ•°ä¸ºstorage_state_changeã€‚**
```python
class DirtyRead(ReentrancyStateMachine):
    # é‡å…¥è°ƒç”¨ä¸­ç¬¬ä¸€ä¸ªsloadçš„depth storage_key => depth
    reentrancy_first_sload_depth: dict[str, int]

    # è®¾ç½®çŠ¶æ€é›†åˆ
    def __init__(self,
                 address: str,
                 storage_key_list: list[str],
                 to_is_target: bool = False):
        super().__init__(address, storage_key_list, to_is_target)
        self.reentrancy_first_sload_depth = {}

        # å®ä¾‹åŒ–çŠ¶æ€
        state0 = State(0)
        state1 = State(1)
        state2 = State(2)
        state3 = State(3)
        state4 = State(4)
        state5 = State(5)
        state6 = State(6)
        state7 = State(7)
        # åˆæ€
        state_start = State(StateMachine.start_state_number, True)
        # ç»ˆæ€
        state_end = State(StateMachine.final_state_number, False, True)

        # åˆå§‹åŒ–ä¸€ä¸ªç”¨äºåˆ¤æ–­è„è¯»çš„çŠ¶æ€æœº
        state_machine = StateMachine()
        # è®¾ç½®çŠ¶æ€æœºçš„çŠ¶æ€é›†åˆ
        state_machine.set_states(0, state0)
        state_machine.set_states(1, state1)
        state_machine.set_states(2, state2)
        state_machine.set_states(3, state3)
        state_machine.set_states(4, state4)
        state_machine.set_states(5, state5)
        state_machine.set_states(6, state6)
        state_machine.set_states(7, state7)
        state_machine.set_states(StateMachine.start_state_number, state_start)
        state_machine.set_states(StateMachine.final_state_number, state_end)

        # åˆå§‹åŒ–reentrancy_first_sload_depthå’ŒçŠ¶æ€æœº
        for storage_key in self.storage_key_list:
            self.reentrancy_first_sload_depth[storage_key] = 1
            # æ¯ä¸ªslotéƒ½åˆ†åˆ«éƒ¨ç½²ä¸€ä¸ªçŠ¶æ€æœº
            self.state[storage_key] = copy.deepcopy(state_machine)

    # é’ˆå¯¹ä¸€ä¸ªstorageçš„çŠ¶æ€å˜åŒ–
    def storage_state_change(
        self,
        storage_key: str,
        current_address: str,
        opcode: str,
        depth: int,
        stack: list[str],
    ):
```
<a name="TXvTk"></a>
# ä¸»è¦åŠŸèƒ½ï¼ˆä»£ç æ‰§è¡Œæµç¨‹ï¼‰
![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1721013924691-981fc219-1adf-4e54-822a-4a65dceca20a.png#averageHue=%23272727&clientId=u59378234-a788-4&from=paste&height=292&id=ue999213d&originHeight=438&originWidth=884&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=33759&status=done&style=none&taskId=u9f9c9eae-cbae-44eb-8518-d4c89d5267e&title=&width=589.3333333333334)

<a name="LA9rC"></a>
# æµ‹è¯•ç”¨ä¾‹
è¿›å…¥detectoræ–‡ä»¶å¤¹ä¸‹çš„test.pyä¸­ï¼Œä¿®æ”¹detectå‡½æ•°ä¸­çš„äº¤æ˜“hashå³å¯æ£€æŸ¥ã€‚<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1721013973358-b244f184-1892-4c63-929d-b92b1e924c23.png#averageHue=%23282e36&clientId=u59378234-a788-4&from=paste&height=82&id=u8c735a1e&originHeight=123&originWidth=1156&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=46510&status=done&style=none&taskId=uc4a8c501-14fb-47b1-be12-2efecce7475&title=&width=770.6666666666666)
```python
# å¯¼åŒ…ï¼ŒsysåŒ…ç”¨äºé…ç½®ç¨‹åºæ‰§è¡Œè·¯å¾„ï¼Œå¦‚æœæŠ¥é”™å¦‚ä¸‹å›¾1ï¼ŒmoduleNotFoundï¼Œåˆ™éœ€è¦æ·»åŠ è¯¥åŒ…
import web3
import time
import sys

# æ·»åŠ è·¯å¾„ï¼Œè·¯å¾„åˆ°EM_Teamå³å¯
sys.path.append("your code path")
# å¯¼å…¥æ¨¡å—
from common.config import load_config_file
from common.evm_network import build_rpc_node
from detector.reentrancy_detector import ReentrancyDetector

# é…ç½®ç½‘ç»œä¿¡æ¯ï¼Œè¿æ¥åˆ°rpcèŠ‚ç‚¹
network = "eth"
config = load_config_file()
network_config = config.networks.get(network)
rpc_node = build_rpc_node(network_config)
# åˆ›å»ºdetectorï¼Œè¿›è¡Œé‡å…¥æ£€æŸ¥
detector = ReentrancyDetector(rpc_node=rpc_node)
print(rpc_node.web3.is_connected())
# è®°å½•ç¨‹åºå¼€å§‹è¿è¡Œçš„æ—¶é—´
start = time.perf_counter()
# é‡å…¥æ£€æµ‹
result = detector.detect(
    '0xd4fafa1261f6e4f9c8543228a67caf9d02811e4ad3058a2714323964a8db61f6')
# è¾“å‡ºä¸ºä¸‹å›¾2
print(result)
# è®°å½•ç¨‹åºç»“æŸè¿è¡Œçš„æ—¶é—´
end = time.perf_counter()

# è®¡ç®—ç¨‹åºè¿è¡Œæ—¶é—´
elapsed = end - start
print(f"detector run time is {elapsed} s")
pass
```
**å›¾1**<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1721014006491-e71dccb6-aa5a-4643-82a8-03d533de4e82.png#averageHue=%23303842&clientId=u59378234-a788-4&from=paste&height=113&id=u1aa6a43a&originHeight=169&originWidth=1021&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=79751&status=done&style=none&taskId=uc55afee6-57ba-4acc-bd30-f53072b295b&title=&width=680.6666666666666)<br />**å›¾2**<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1721014014867-96ba6621-5146-48a5-adf2-e82e7a48b475.png#averageHue=%232d323b&clientId=u59378234-a788-4&from=paste&height=159&id=u0623709e&originHeight=238&originWidth=1795&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=128748&status=done&style=none&taskId=ufd0b5fe8-a7e1-4080-a44f-54632fd055b&title=&width=1196.6666666666667)<br />è¾“å‡ºåˆ†æï¼š

- True -> è¿æ¥åˆ°rpcèŠ‚ç‚¹
- rpc fetch is ok -> å·²ç»é€šè¿‡rpcèŠ‚ç‚¹è·å¾—äº†è¯¥äº¤æ˜“çš„ä¿¡æ¯
- start to detect address:  0xf2919d1d80aff2940274014bef534f7791906ff2 -> å¼€å§‹æ£€æµ‹åœ°å€ï¼Œè¯¥åœ°å€ä¸ºåœ¨ç¯è·¯callè°ƒç”¨è·¯å¾„ä¸­é‡å¤è¿›å…¥çš„
- {'0xf2919d1d80aff2940274014bef534f7791906ff2': {0: [], 1: [], 2: [], 3: []} 
   - 0xf2919d1d80aff2940274014bef534f7791906ff2 -> è¢«æ£€æµ‹åœ°å€
   - {0: [], 1: [], 2: [], 3: []} -> 0ï¼Œ1ï¼Œ2ï¼Œ3åˆ†åˆ«ä»£è¡¨ä¸‰ä¸ªçŠ¶æ€æœºï¼Œ[]ä»£è¡¨æ²¡æœ‰å“ªä¸ªstorageè¢«æ£€æµ‹åˆ°å­˜åœ¨é‡å…¥é£é™©
   - ä¸‹é¢æ˜¯ä¸€ä¸ªå­˜åœ¨é‡å…¥é£é™©çš„ä¾‹å­ï¼š
      - '0x9c5a2a6431523fbbc648fb83137a20a2c1789c56': {0: ['0x8', '0x6', '0xa'], 1: ['0xa'], 2: ['0xa'], 3: []}}
      - 0x9c5a2a6431523fbbc648fb83137a20a2c1789c56è¢«æ£€æµ‹åœ°å€
      - {0: ['0x8', '0x6', '0xa'], 1: ['0xa'], 2: ['0xa'], 3: []}
         - 0: ['0x8', '0x6', '0xa'] -> è¢«æ£€æµ‹åœ°å€0x9c5a2a6431523fbbc648fb83137a20a2c1789c56çš„slot 0x8,0x6,0xaå¯èƒ½è¢«è„è¯»
         - 1: ['0xa'] -> è¢«æ£€æµ‹åœ°å€0x9c5a2a6431523fbbc648fb83137a20a2c1789c56çš„slot 0xaå¯èƒ½è¢«è¦†ç›–æ›´æ–°
         - 2: ['0xa'] -> è¢«æ£€æµ‹åœ°å€0x9c5a2a6431523fbbc648fb83137a20a2c1789c56çš„slot 0xaå¯èƒ½å‡ºç°ä¸å¯é‡å¤è¯»æƒ…å†µ
         - 3: [] -> æœªæ£€æµ‹åˆ°å†™åå·®æƒ…å†µ

<a name="QTMQW"></a>
# EXPä»£ç 
<a name="SxLZG"></a>
## 4.1 get_all_call_traceï¼Œè·å–æ‰€æœ‰äº¤æ˜“çš„call_trace
ä»£ç ä½œç”¨ï¼šä»rpc_nodeè·å–æ¯ä¸ªå—ä¸­æ¯ç¬”äº¤æ˜“çš„call_traceï¼Œå¹¶å†™å…¥æ–‡ä»¶ã€‚<br />ä»£ç ä½¿ç”¨ï¼š<br />    main(10000000,11000000,8,30)<br />        startï¼š10000000     å¼€å§‹åŒºå—å·<br />        endï¼š11000000       æœ«å°¾åŒºå—å·<br />        numï¼š8                     åŒºå—å·çš„é•¿åº¦ï¼Œä¾‹å¦‚123ï¼Œåˆ™numä¸º3<br />        thread_numï¼š30      ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤ä¸º23<br />ä»£ç æ‰§è¡Œç»“æœï¼š<br />    è·å¾—ä»10000000-11000000åŒºå—çš„æ‰€æœ‰äº¤æ˜“çš„call_traceï¼Œæ‰€æœ‰ç»“æœä¿å­˜åœ¨â€œ./pickleFolderâ€æ–‡ä»¶å¤¹ä¸­ã€‚<br />æ³¨æ„ï¼šæœ¬ä»£ç æ‰§è¡Œåæ‰€å¾—åˆ°çš„ç»“æœæ˜¯è¿›è¡Œäº¤æ˜“ç¯è·¯åˆ¤æ–­çš„åŸºæœ¬ä¿¡æ¯ï¼Œåœ¨find_loopæ–‡ä»¶ä¸­çš„loadå‡½æ•°ä¾èµ–äºè¿™äº›ä¿¡æ¯ã€‚
```python
# è¯»å–pickleæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¸­åŒ…å«äº†æ¯ä¸ªå—ä¸­æ¯ç¬”äº¤æ˜“çš„call_trace
def load(block_number) -> dict:
    # æ³¨æ„ï¼ï¼ï¼ è¿™é‡Œå¦‚æœæ— æ³•è¯»å–åˆ°ä¿¡æ¯ä¼šæŠ¥é”™
    path = f"./pickleFolder/{block_number}.pickle"
    if os.path.getsize(path):
        with open(path, "rb") as f:
            return pickle.load(f)
```
<a name="iVvN8"></a>
## 4.2 find_loop æ ¹æ®äº¤æ˜“çš„call_traceåˆ¤æ–­äº¤æ˜“æ˜¯å¦å­˜åœ¨ç¯è·¯ï¼Œç”¨äºç¼©å°æ•°æ®é›†
ä»£ç ä½œç”¨ï¼šè¯»å–./pickleFolderä¸­çš„æŒ‡å®šåŒºå—åŒºé—´ï¼Œåˆ†ææ¯ä¸ªåŒºå—çš„äº¤æ˜“call_traceæ˜¯å¦å­˜åœ¨ç¯è·¯ï¼Œå­˜åœ¨åˆ™ä¿å­˜åˆ°æœ¬åœ°ã€‚<br />ä»£ç ä½¿ç”¨ï¼š<br />    main(10000000,11000000,8,120)<br />        startï¼š10000000     å¼€å§‹åŒºå—å·<br />        endï¼š11000000       æœ«å°¾åŒºå—å·<br />        numï¼š8                     åŒºå—å·çš„é•¿åº¦ï¼Œä¾‹å¦‚123ï¼Œåˆ™numä¸º3<br />        thread_numï¼š120      ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤ä¸º60<br />ä»£ç æ‰§è¡Œç»“æœï¼š<br />    è·å¾—ä»10000000-11000000åŒºå—çš„æ‰€æœ‰äº¤æ˜“çš„call_traceï¼Œæ‰€æœ‰ç»“æœä¿å­˜åœ¨â€œ./useful_txâ€æ–‡ä»¶å¤¹ä¸­ï¼Œæ–‡ä»¶å¤¹ä¸­çš„æ¯ä¸ªæ–‡ä»¶ä¿å­˜äº†å½“å‰å—çš„ç¯è·¯äº¤æ˜“ã€‚<br />æ³¨æ„ï¼šå½“å‰çš„ç¯è·¯åˆ¤æ–­å­˜åœ¨ä¸€ä¸ªtodoï¼Œå¯èƒ½é—æ¼fallbackæƒ…å†µï¼Œéœ€è¦è¿›è¡Œä¿®æ”¹ã€‚
```python
    # è¿™é‡Œè¿‡æ»¤éå‡½æ•°è°ƒç”¨ï¼Œä½†æ˜¯é‡å…¥å­˜åœ¨ä¸€ä¸ªfallbackæƒ…å†µï¼Œè¿™æ—¶çš„inputä¹Ÿå°äº10.
    if len(calltrace.get("input")) < 10:
        return looplist
    
```
<a name="NOc5v"></a>
## 4.3 extract_tx æå–æ‰€æœ‰äº¤æ˜“åˆ°ä¸€ä¸ªæ–‡ä»¶
ä»£ç ä½œç”¨ï¼šè¯»å–./useful_txä¸­çš„æŒ‡å®šåŒºå—åŒºé—´ï¼Œå°†åŒºå—çš„æ‰€æœ‰ç¯è·¯äº¤æ˜“é›†ä¸­åˆ°ä¸€ä¸ªpickleæ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿è¯»å–ã€‚<br />ä»£ç ä½¿ç”¨ï¼š<br />    main(10000000,11000000,120)<br />        startï¼š10000000     å¼€å§‹åŒºå—å·<br />        endï¼š11000000       æœ«å°¾åŒºå—å·<br />        thread_numï¼š120      ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤ä¸º100<br />ä»£ç æ‰§è¡Œç»“æœï¼š<br />    å°†10000000-11000000åŒºå—çš„æ‰€æœ‰ç¯è·¯äº¤æ˜“ä¿å­˜åˆ°"./all_tx.pickle"ä¸­ã€‚<br />æ³¨æ„ï¼šæœ¬å‡½æ•°ä¸ºä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œä¾èµ–äº./useful_txæ–‡ä»¶å¤¹ä¸­çš„å†…å®¹ï¼Œå¦‚æœæ–‡ä»¶å¤¹ä¸­ç¼ºå°‘æŸä¸ªåŒºå—ï¼Œåˆ™ä¼šæŠ¥é”™ï¼
<a name="TSjez"></a>
## 4.4 detect_all_tx æ£€æµ‹æ‰€æœ‰çš„äº¤æ˜“
ä»£ç ä½œç”¨ï¼šè¯»å–tx_pathä¸­çš„æ‰€æœ‰äº¤æ˜“ï¼Œå¤šè¿›ç¨‹ï¼Œå¤šçº¿ç¨‹çš„åˆ†æäº¤æ˜“ã€‚å°†åˆ†æç»“æœä¿å­˜åœ¨result_pathä¸­ã€‚<br />ä»£ç ä½¿ç”¨ï¼š<br />    main("all_tx.pickle","./result")<br />        tx_pathï¼š"all_tx.pickle"     æ‰€æœ‰äº¤æ˜“æ‰€åœ¨çš„åœ°å€<br />        result_pathï¼š"./result"       ç»“æœä¿å­˜çš„åœ°å€<br />ä»£ç æ‰§è¡Œç»“æœï¼š<br />    åˆ†æall_tx.pickleä¸­çš„æ‰€æœ‰äº¤æ˜“æ˜¯å¦å­˜åœ¨é‡å…¥ï¼Œä¿å­˜æ‰€æœ‰çš„é‡å…¥æ£€æµ‹ç»“æœåˆ°./resultä¸­ã€‚æŸäº›æ£€æµ‹å¤±è´¥çš„äº¤æ˜“ä¿å­˜åœ¨"./problem_tx.pickle"ä¸­ã€‚
<a name="oqKR0"></a>
## 4.5 foreach_result éå†ç»“æœï¼Œå¾—å‡ºç»“è®º
ä»£ç ä½œç”¨ï¼šè¯»å–result_pathä¸­çš„æ‰€æœ‰ç»“æœï¼Œå¹¶åœ¨æ§åˆ¶å°è¾“å‡ºæœ€ç»ˆçš„é‡å…¥äº¤æ˜“æ¯”ä¾‹ã€‚<br />ä»£ç ä½¿ç”¨ï¼š<br />    main("./result")<br />        result_pathï¼š"./result"       æ‰€æœ‰çš„æ£€æµ‹ç»“æœæ‰€åœ¨çš„åœ°å€<br />ä»£ç æ‰§è¡Œç»“æœï¼š<br />    åœ¨æ§åˆ¶å°è¾“å‡º"./result"ä¸­é‡å…¥äº¤æ˜“æ¯”ä¾‹
<a name="ZA91p"></a>
## 4.6 å…¨ç½‘æ£€æµ‹æµç¨‹

1. ä½¿ç”¨get_all_call_traceè·å¾—å¤§é‡äº¤æ˜“çš„call_trace
2. ä½¿ç”¨find_loopæ‰¾å‡ºæ‰€æœ‰çš„ç¯è·¯äº¤æ˜“
3. ä½¿ç”¨extract_txæå–æ‰€æœ‰çš„ç¯è·¯äº¤æ˜“åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­
4. ä½¿ç”¨detect_all_txæ£€æµ‹æ‰€æœ‰çš„ç¯è·¯äº¤æ˜“ï¼Œå¹¶å°†ç»“æœä¿å­˜
5. ä½¿ç”¨foreach_resultéå†æ‰€æœ‰ç»“æœï¼Œå¾—å‡ºé‡å…¥äº¤æ˜“å æ‰€æœ‰äº¤æ˜“çš„æ•°é‡

<a name="SXJHA"></a>
# çŠ¶æ€æœºè§£æ
<a name="PcdBm"></a>
## è„è¯»
![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1721014091300-4ff57e45-0d3a-459e-ac24-a4e03373092b.png#averageHue=%23fcfbfb&clientId=u59378234-a788-4&from=paste&height=770&id=uf53f2c22&originHeight=1155&originWidth=1500&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=277200&status=done&style=none&taskId=u70957418-3e96-454f-902e-8240ff3a975&title=&width=1000)<br />è„è¯»ï¼š

ä¾‹å¦‚ï¼šA -> B-1 -> C -> B-2 -> ... -> B-1 -> ï¼ˆB-1ä»£è¡¨ åœ°å€-call_depthï¼‰

åœ¨é‡å…¥è¿‡ç¨‹ä¸­,æŸä¸€å±‚é‡å…¥æ—¶å‡ºç°äº†sloadæŒ‡ä»¤ã€‚

è€Œååœ¨é‡å…¥å›é€€æ—¶åˆå‡ºç°äº†sstoreæŒ‡ä»¤ï¼Œåˆ™è¯´æ˜ä¸ºè„è¯»ã€‚

åœ¨è¿™é‡Œçš„ä¾‹å­ä½“ç°ä¸ºï¼Œåœ¨B-2æ—¶å‡ºç°sloadï¼Œè€Œåœ¨B-1å‡ºç°sstoreã€‚

  <br />ä¸ºä»€ä¹ˆæ˜¯è„è¯»ï¼Ÿ

è„è¯»å³ä¸ºè¯»å–åˆ°äº†ä¸ºæäº¤çš„æ•°æ®ï¼ŒB-2è¯»å–çš„æ•°æ®å°±æ˜¯æœªæäº¤æ•°æ®ï¼Œå› ä¸º

B-1æ—¶åˆå¯¹æ•°æ®è¿›è¡Œäº†å†™å…¥ã€‚æˆ‘ä»¬ä¸ç¡®å®šè¯»å–çš„æ•°æ®æ˜¯å¦æ­£ç¡®ï¼Œæ‰€ä»¥è®¤ä¸º

è¿™ç§æƒ…å†µå­˜åœ¨é‡å…¥é£é™©ã€‚

**å›¾è§£æ**

startæ˜¯åˆå§‹çŠ¶æ€ï¼Œå½“äº¤æ˜“æ‰§è¡Œæ—¶å‡ºç°å¯¹ç›®æ ‡åœ°å€çš„è°ƒç”¨æ—¶ï¼Œå¯èƒ½è½¬åˆ°çŠ¶æ€0æˆ–çŠ¶æ€1ï¼Œè¿™å–å†³äºto_is_targetå˜é‡ã€‚

to_is_targetå˜é‡æ ‡è¯†äº¤æ˜“çš„toåœ°å€æ˜¯å¦ä¸ºç›®æ ‡åœ°å€ã€‚ä¾‹å¦‚äº¤æ˜“callè°ƒç”¨ä¸ºA -> B -> C -> Bï¼Œåˆ™to_is_targetä¸ºtrueï¼Œå› ä¸ºtoåœ°å€ä¸ºBï¼Œä¸”Båœ°å€é‡å¤å‡ºç°ã€‚

to_is_targetå˜é‡å€¼ä¸ºtrueï¼Œåˆ™callè°ƒç”¨ä¸­åœ¨æ­¤è°ƒç”¨ä¸€æ¬¡ç›®æ ‡åœ°å€åˆ™è¯´æ˜å‡ºç°é‡å…¥ã€‚

æ ¹æ®to_is_targetæ¥åˆ†æƒ…å†µè®¨è®ºçš„åŸå› æ˜¯ï¼šå½“to_is_targetæ—¶ï¼Œè¯´æ˜äº¤æ˜“çš„toåœ°å€ä¸ºæ£€æµ‹åœ°å€ï¼Œé‚£ä¹ˆå½“æœ€å¤–å±‚é‡å…¥ç»“æŸæ—¶ï¼Œå¯ä»¥ç›´æ¥ç»“æŸæ£€æµ‹ã€‚è€Œto_is_not_targetï¼Œå½“æœ€å¤–å±‚é‡å…¥ç»“æŸæ—¶ï¼Œä¾ç„¶å­˜åœ¨å¯èƒ½å­˜åœ¨è°ƒç”¨ï¼Œå› æ­¤éœ€è¦ç»§ç»­ç­‰å¾…æœ€å¤–å±‚callè°ƒç”¨æ— å›æ»šç»“æŸ

çŠ¶æ€1ï¼šæœ‰ä¸‰ç§æƒ…å†µ 1ï¼‰é‡å…¥ç›´æ¥ç»“æŸï¼Œ2ï¼‰åœ¨é‡å…¥æœ€å¤–å±‚å‡ºç°sloadï¼Œ3ï¼‰åœ¨é‡å…¥å­è°ƒç”¨ä¸­å‡ºç°sloadã€‚å…³é”®åœ¨äºsloadæŒ‡ä»¤çš„å‡ºç°ï¼Œå¹¶ä¸”åˆ†äº†ä¸¤ç§æƒ…å†µï¼š1ï¼‰æœ€å¤–å±‚é‡å…¥ï¼Œ2ï¼‰é‡å…¥å­è°ƒç”¨ã€‚

åˆ†æƒ…å†µè®¨è®ºçš„åŸå› æ˜¯ï¼šå¦‚æœæ˜¯åœ¨æœ€å¤–å±‚é‡å…¥ä¸­sloadï¼Œåˆ™æˆ‘ä»¬ä¸å…³å¿ƒé‡å…¥å­è°ƒç”¨ï¼Œåªè¦å½“å‰å±‚ä¸å›æ»šå³å¯ï¼›å¦‚æœæ˜¯é‡å…¥å­è°ƒç”¨ä¸­å‡ºç°sloadï¼Œæˆ‘ä»¬è¦å…³å¿ƒåç»­çš„é‡å…¥å­è°ƒç”¨ï¼Œå› ä¸ºé‡å…¥å­è°ƒç”¨å›æ»šå°†å¯¼è‡´çˆ¶è°ƒç”¨ä¹Ÿå›æ»šã€‚

çŠ¶æ€4ï¼Œ5ï¼šåœ¨çŠ¶æ€4ï¼Œ5æ—¶ï¼Œå…³å¿ƒæ˜¯å¦æœ‰sstoreå‡ºç°åœ¨é‡å…¥çš„çˆ¶è°ƒç”¨ã€‚<br />ä¾‹å¦‚ï¼šA -> B-1 -> C -> B-2 -> B-3 -> ... -> B-2ï¼Œè¿™é‡Œçš„B-2å°±æ˜¯é‡å…¥çˆ¶è°ƒç”¨ã€‚

æœ€ç»ˆï¼Œæˆ‘ä»¬éœ€è¦ç­‰åˆ°æœ€å¤–å±‚callä¸å›æ»šæ‰èƒ½è¯´æ˜è¯¥äº¤æ˜“æ˜¯ä¸€ç¬”è„è¯»ã€‚

<a name="s9YCp"></a>
# æœåŠ¡å™¨æ•°æ®
![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1722306726736-c853c804-2ce3-49d2-b476-c3c75b10d627.png#averageHue=%23222832&clientId=uff6b68ca-8d14-4&from=paste&height=58&id=ue21465de&originHeight=73&originWidth=1006&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=13639&status=done&style=none&taskId=u0f996a35-6cc4-41ec-9542-a5544e3a4ba&title=&width=804.8)<br />dataåŒ…å«äº†ç”¨å¾—ä¸Šçš„æ•°æ®

1. 21-23å¹´æ‰€æœ‰äº¤æ˜“çš„call_trace![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1722306961061-3ea46800-4f6b-4d86-9e7f-97535e14f902.png#averageHue=%2321252e&clientId=uff6b68ca-8d14-4&from=paste&height=86&id=ue202ce15&originHeight=129&originWidth=2196&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=26685&status=done&style=none&taskId=u150cc431-875e-4975-961e-a399df48df2&title=&width=1464)
2. ç»è¿‡ç¯è·¯ç­›é€‰çš„21-23æ‰€æœ‰äº¤æ˜“![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1722307009026-e65fc8cb-d901-4100-9743-d1fd724d3b8d.png#averageHue=%23212732&clientId=uff6b68ca-8d14-4&from=paste&height=44&id=u4f58c598&originHeight=66&originWidth=2185&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=16178&status=done&style=none&taskId=u8f354759-697e-49c9-9c16-252c9793fea&title=&width=1456.6666666666667)
3. 21-23å¹´æ¯ä¸ªå—çš„ç¯è·¯äº¤æ˜“![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1722307033581-a01bd2c2-2665-468f-ae2b-02f9dc56a4c3.png#averageHue=%23212630&clientId=uff6b68ca-8d14-4&from=paste&height=65&id=yrBy6&originHeight=97&originWidth=2179&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=22758&status=done&style=none&taskId=ud5993b66-e54a-4872-a3cd-a483755f4c9&title=&width=1452.6666666666667)
4. 21-23å¹´å·²ç»è·‘å‡ºæ¥çš„äº¤æ˜“ç»“æœ![image.png](https://cdn.nlark.com/yuque/0/2024/png/25588623/1722307060110-23a87f64-5e8d-4fd5-9330-46f604c779e5.png#averageHue=%2321252f&clientId=uff6b68ca-8d14-4&from=paste&height=69&id=u9c8d00b5&originHeight=103&originWidth=2197&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=21745&status=done&style=none&taskId=u6b0735e4-1bc1-4ff8-bd1b-c2ed981c341&title=&width=1464.6666666666667)

æ³¨æ„ï¼š

1. çŠ¶æ€æœº5è¿˜æœªå®Œå–„
2. çŠ¶æ€æœº4çš„å®éªŒè¿˜æ²¡è·‘å®Œ
3. è¿˜æœ‰ä¸€ä¸ªæ–‡ä»¶resultï¼Œé‡Œé¢åŒ…å«äº†å¾ˆå¤šresultï¼Œä½†æ˜¯æœ€åˆåšå®éªŒæ—¶æ²¡æœ‰åšæ ‡è®°ï¼Œæ‰€ä»¥å·²ç»ä¸çŸ¥é“æ˜¯ä»€ä¹ˆäº†ğŸ˜‚
<a name="jZMsH"></a>
# todoList

1. çŠ¶æ€æœº5ï¼Œè¯»åå·®çŠ¶æ€æœºçš„ç¼–å†™

